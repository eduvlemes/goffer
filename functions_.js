const path = 'http://127.0.0.1:5500/assets/small';
const aviso_titulo = 'Atenção! Limite por pedido';
const aviso_mensagem = 'No momento é possível comprar apenas uma unidade de cada variação por pedido.';
const customizer = [
  {
    productId: 367724086,
    title: 'Personalize sua chocker!',
    customizations: [
      {
        title: 'Cor do Laço 1',
        type: 'required',
        message: 'Escolha uma cor para prosseguir',
        enableOnVariants: [],
        options: [
          { label: 'Amarelo', image: `${path}/amarelo-1.png`, enabled: true },
          { label: 'Azul-turquesa', image: `${path}/azul-turquesa-1.png`, enabled: true },
          { label: 'Bandeira', image: `${path}/bandeira-1.png`, enabled: true },
          { label: 'Branco', image: `${path}/branco-1.png`, enabled: true },
          { label: 'Branco-lar', image: `${path}/branco-lar-1.png`, enabled: true },
          { label: 'Celeste', image: `${path}/celeste-1.png`, enabled: true },
          { label: 'Laranja', image: `${path}/larannja-1.png`, enabled: true },
          { label: 'Lilas', image: `${path}/lilas-1.png`, enabled: true },
          { label: 'Marinho', image: `${path}/marinho-1.png`, enabled: true },
          { label: 'Rosa-neon', image: `${path}/rosa-neon-1.png`, enabled: true },
          { label: 'Rosa-pink', image: `${path}/rosa-pink-2.png`, enabled: true },
          { label: 'Roxo', image: `${path}/roxo-1.png`, enabled: true },
          { label: 'Royal', image: `${path}/royal-1.png`, enabled: true },
          { label: 'Verde-agua', image: `${path}/verde-agua1.png`, enabled: true },
          { label: 'Verde-neon', image: `${path}/verde-neon-1.png`, enabled: true },
          { label: 'Vermelho', image: `${path}/vermelho-1.png`, enabled: true }
        ]
      },
      {
        title: 'Cor do Laço 2',
        type: 'required',
        message: 'Escolha uma cor para prosseguir',
        enableOnVariants: [],
        options: [
          { label: 'Amarelo', image: `${path}/amarelo-1.png`, enabled: true },
          { label: 'Azul-turquesa', image: `${path}/azul-turquesa-1.png`, enabled: true },
          { label: 'Bandeira', image: `${path}/bandeira-1.png`, enabled: true },
          { label: 'Branco', image: `${path}/branco-1.png`, enabled: true },
          { label: 'Branco-lar', image: `${path}/branco-lar-1.png`, enabled: true },
          { label: 'Celeste', image: `${path}/celeste-1.png`, enabled: true },
          { label: 'Laranja', image: `${path}/larannja-1.png`, enabled: true },
          { label: 'Lilas', image: `${path}/lilas-1.png`, enabled: true },
          { label: 'Marinho', image: `${path}/marinho-1.png`, enabled: true },
          { label: 'Rosa-neon', image: `${path}/rosa-neon-1.png`, enabled: true },
          { label: 'Rosa-pink', image: `${path}/rosa-pink-2.png`, enabled: true },
          { label: 'Roxo', image: `${path}/roxo-1.png`, enabled: true },
          { label: 'Royal', image: `${path}/royal-1.png`, enabled: true },
          { label: 'Verde-agua', image: `${path}/verde-agua1.png`, enabled: true },
          { label: 'Verde-neon', image: `${path}/verde-neon-1.png`, enabled: true },
          { label: 'Vermelho', image: `${path}/vermelho-1.png`, enabled: true }
        ]
      },
      {
        title: 'Pingente 1',
        type: 'required',
        message: 'Escolha um pingente para prosseguir',
        enableOnVariants: [],
        options: [
          { label: '1', image: `${path}/pingente-1.png`, enabled: true },
          { label: '2', image: `${path}/pingente-2.png`, enabled: true },
          { label: '3', image: `${path}/pingente-3.png`, enabled: true },
          { label: '4', image: `${path}/pingente-4.png`, enabled: true },
          { label: '5', image: `${path}/pingente-5.png`, enabled: true },
          { label: '6', image: `${path}/pingente-6.png`, enabled: true },
          { label: '7', image: `${path}/pingente-7.png`, enabled: true },
          { label: '8', image: `${path}/pingente-8.png`, enabled: true },
          { label: '9', image: `${path}/pingente-9.png`, enabled: true },
          { label: '10', image: `${path}/pingente-10.png`, enabled: true },
          { label: '11', image: `${path}/pingente-11.png`, enabled: true },
          { label: '12', image: `${path}/pingente-12.png`, enabled: true },
          { label: '13', image: `${path}/pingente-13.png`, enabled: true },
          { label: '14', image: `${path}/pingente-14.png`, enabled: true },
          { label: '15', image: `${path}/pingente-15.png`, enabled: true },
          { label: '16', image: `${path}/pingente-16.png`, enabled: true },
          { label: '17', image: `${path}/pingente-17.png`, enabled: true },
          { label: '18', image: `${path}/pingente-18.png`, enabled: true },
          { label: '19', image: `${path}/pingente-19.png`, enabled: true },
          { label: '20', image: `${path}/pingente-20.png`, enabled: true },
          { label: '21', image: `${path}/pingente-21.png`, enabled: true },
          { label: '22', image: `${path}/pingente-22.png`, enabled: true },
          { label: '23', image: `${path}/pingente-23.png`, enabled: true },
          { label: '24', image: `${path}/pingente-24.png`, enabled: true },
          { label: '25', image: `${path}/pingente-25.png`, enabled: true },
          { label: '26', image: `${path}/pingente-26.png`, enabled: true },
          { label: '27', image: `${path}/pingente-27.png`, enabled: true },
          { label: '28', image: `${path}/pingente-28.png`, enabled: true },
          { label: '29', image: `${path}/pingente-29.png`, enabled: true },
          { label: '30', image: `${path}/pingente-30.png`, enabled: true },
          { label: '31', image: `${path}/pingente-31.png`, enabled: true },
          { label: '32', image: `${path}/pingente-32.png`, enabled: true },
          { label: '33', image: `${path}/pingente-33.png`, enabled: true },
          { label: '34', image: `${path}/pingente-34.png`, enabled: true },
          { label: '35', image: `${path}/pingente-35.png`, enabled: true },
          { label: '36', image: `${path}/pingente-36.png`, enabled: true },
          { label: '37', image: `${path}/pingente-37.png`, enabled: true },
          { label: '38', image: `${path}/pingente-38.png`, enabled: true },
          { label: '39', image: `${path}/pingente-39.png`, enabled: true },
          { label: '40', image: `${path}/pingente-40.png`, enabled: true },
          { label: '41', image: `${path}/pingente-41.png`, enabled: true },
          { label: '42', image: `${path}/pingente-42.png`, enabled: true },
          { label: '43', image: `${path}/pingente-43.png`, enabled: true },
          { label: '44', image: `${path}/pingente-44.png`, enabled: true },
          { label: '45', image: `${path}/pingente-45.png`, enabled: true },
          { label: '46', image: `${path}/pingente-46.png`, enabled: true },
          { label: '47', image: `${path}/pingente-47.png`, enabled: true },
          { label: '48', image: `${path}/pingente-48.png`, enabled: true },
          { label: '49', image: `${path}/pingente-49.png`, enabled: true },
          { label: '50', image: `${path}/pingente-50.png`, enabled: true },
          { label: '51', image: `${path}/pingente-51.png`, enabled: true },
          { label: '52', image: `${path}/pingente-52.png`, enabled: true },
          { label: '53', image: `${path}/pingente-53.png`, enabled: true },
          { label: '54', image: `${path}/pingente-54.png`, enabled: true },
          { label: '55', image: `${path}/pingente-55.png`, enabled: true },
          { label: '56', image: `${path}/pingente-56.png`, enabled: true }
        ]
      },
      {
        title: 'Pingente 2',
        type: 'required',
        message: 'Escolha um pingente para prosseguir',
        enableOnVariants: [14005496,14005497],
        options: [
          { label: '1', image: `${path}/pingente-1.png`, enabled: true },
          { label: '2', image: `${path}/pingente-2.png`, enabled: true },
          { label: '3', image: `${path}/pingente-3.png`, enabled: true },
          { label: '4', image: `${path}/pingente-4.png`, enabled: true },
          { label: '5', image: `${path}/pingente-5.png`, enabled: true },
          { label: '6', image: `${path}/pingente-6.png`, enabled: true },
          { label: '7', image: `${path}/pingente-7.png`, enabled: true },
          { label: '8', image: `${path}/pingente-8.png`, enabled: true },
          { label: '9', image: `${path}/pingente-9.png`, enabled: true },
          { label: '10', image: `${path}/pingente-10.png`, enabled: true },
          { label: '11', image: `${path}/pingente-11.png`, enabled: true },
          { label: '12', image: `${path}/pingente-12.png`, enabled: true },
          { label: '13', image: `${path}/pingente-13.png`, enabled: true },
          { label: '14', image: `${path}/pingente-14.png`, enabled: true },
          { label: '15', image: `${path}/pingente-15.png`, enabled: true },
          { label: '16', image: `${path}/pingente-16.png`, enabled: true },
          { label: '17', image: `${path}/pingente-17.png`, enabled: true },
          { label: '18', image: `${path}/pingente-18.png`, enabled: true },
          { label: '19', image: `${path}/pingente-19.png`, enabled: true },
          { label: '20', image: `${path}/pingente-20.png`, enabled: true },
          { label: '21', image: `${path}/pingente-21.png`, enabled: true },
          { label: '22', image: `${path}/pingente-22.png`, enabled: true },
          { label: '23', image: `${path}/pingente-23.png`, enabled: true },
          { label: '24', image: `${path}/pingente-24.png`, enabled: true },
          { label: '25', image: `${path}/pingente-25.png`, enabled: true },
          { label: '26', image: `${path}/pingente-26.png`, enabled: true },
          { label: '27', image: `${path}/pingente-27.png`, enabled: true },
          { label: '28', image: `${path}/pingente-28.png`, enabled: true },
          { label: '29', image: `${path}/pingente-29.png`, enabled: true },
          { label: '30', image: `${path}/pingente-30.png`, enabled: true },
          { label: '31', image: `${path}/pingente-31.png`, enabled: true },
          { label: '32', image: `${path}/pingente-32.png`, enabled: true },
          { label: '33', image: `${path}/pingente-33.png`, enabled: true },
          { label: '34', image: `${path}/pingente-34.png`, enabled: true },
          { label: '35', image: `${path}/pingente-35.png`, enabled: true },
          { label: '36', image: `${path}/pingente-36.png`, enabled: true },
          { label: '37', image: `${path}/pingente-37.png`, enabled: true },
          { label: '38', image: `${path}/pingente-38.png`, enabled: true },
          { label: '39', image: `${path}/pingente-39.png`, enabled: true },
          { label: '40', image: `${path}/pingente-40.png`, enabled: true },
          { label: '41', image: `${path}/pingente-41.png`, enabled: true },
          { label: '42', image: `${path}/pingente-42.png`, enabled: true },
          { label: '43', image: `${path}/pingente-43.png`, enabled: true },
          { label: '44', image: `${path}/pingente-44.png`, enabled: true },
          { label: '45', image: `${path}/pingente-45.png`, enabled: true },
          { label: '46', image: `${path}/pingente-46.png`, enabled: true },
          { label: '47', image: `${path}/pingente-47.png`, enabled: true },
          { label: '48', image: `${path}/pingente-48.png`, enabled: true },
          { label: '49', image: `${path}/pingente-49.png`, enabled: true },
          { label: '50', image: `${path}/pingente-50.png`, enabled: true },
          { label: '51', image: `${path}/pingente-51.png`, enabled: true },
          { label: '52', image: `${path}/pingente-52.png`, enabled: true },
          { label: '53', image: `${path}/pingente-53.png`, enabled: true },
          { label: '54', image: `${path}/pingente-54.png`, enabled: true },
          { label: '55', image: `${path}/pingente-55.png`, enabled: true },
          { label: '56', image: `${path}/pingente-56.png`, enabled: true }
        ]
      },
      {
        title: 'Pingente 3',
        type: 'required',
        message: 'Escolha um pingente para prosseguir',
        enableOnVariants: [14005497],
        options: [
          { label: '1', image: `${path}/pingente-1.png`, enabled: true },
          { label: '2', image: `${path}/pingente-2.png`, enabled: true },
          { label: '3', image: `${path}/pingente-3.png`, enabled: true },
          { label: '4', image: `${path}/pingente-4.png`, enabled: true },
          { label: '5', image: `${path}/pingente-5.png`, enabled: true },
          { label: '6', image: `${path}/pingente-6.png`, enabled: true },
          { label: '7', image: `${path}/pingente-7.png`, enabled: true },
          { label: '8', image: `${path}/pingente-8.png`, enabled: true },
          { label: '9', image: `${path}/pingente-9.png`, enabled: true },
          { label: '10', image: `${path}/pingente-10.png`, enabled: true },
          { label: '11', image: `${path}/pingente-11.png`, enabled: true },
          { label: '12', image: `${path}/pingente-12.png`, enabled: true },
          { label: '13', image: `${path}/pingente-13.png`, enabled: true },
          { label: '14', image: `${path}/pingente-14.png`, enabled: true },
          { label: '15', image: `${path}/pingente-15.png`, enabled: true },
          { label: '16', image: `${path}/pingente-16.png`, enabled: true },
          { label: '17', image: `${path}/pingente-17.png`, enabled: true },
          { label: '18', image: `${path}/pingente-18.png`, enabled: true },
          { label: '19', image: `${path}/pingente-19.png`, enabled: true },
          { label: '20', image: `${path}/pingente-20.png`, enabled: true },
          { label: '21', image: `${path}/pingente-21.png`, enabled: true },
          { label: '22', image: `${path}/pingente-22.png`, enabled: true },
          { label: '23', image: `${path}/pingente-23.png`, enabled: true },
          { label: '24', image: `${path}/pingente-24.png`, enabled: true },
          { label: '25', image: `${path}/pingente-25.png`, enabled: true },
          { label: '26', image: `${path}/pingente-26.png`, enabled: true },
          { label: '27', image: `${path}/pingente-27.png`, enabled: true },
          { label: '28', image: `${path}/pingente-28.png`, enabled: true },
          { label: '29', image: `${path}/pingente-29.png`, enabled: true },
          { label: '30', image: `${path}/pingente-30.png`, enabled: true },
          { label: '31', image: `${path}/pingente-31.png`, enabled: true },
          { label: '32', image: `${path}/pingente-32.png`, enabled: true },
          { label: '33', image: `${path}/pingente-33.png`, enabled: true },
          { label: '34', image: `${path}/pingente-34.png`, enabled: true },
          { label: '35', image: `${path}/pingente-35.png`, enabled: true },
          { label: '36', image: `${path}/pingente-36.png`, enabled: true },
          { label: '37', image: `${path}/pingente-37.png`, enabled: true },
          { label: '38', image: `${path}/pingente-38.png`, enabled: true },
          { label: '39', image: `${path}/pingente-39.png`, enabled: true },
          { label: '40', image: `${path}/pingente-40.png`, enabled: true },
          { label: '41', image: `${path}/pingente-41.png`, enabled: true },
          { label: '42', image: `${path}/pingente-42.png`, enabled: true },
          { label: '43', image: `${path}/pingente-43.png`, enabled: true },
          { label: '44', image: `${path}/pingente-44.png`, enabled: true },
          { label: '45', image: `${path}/pingente-45.png`, enabled: true },
          { label: '46', image: `${path}/pingente-46.png`, enabled: true },
          { label: '47', image: `${path}/pingente-47.png`, enabled: true },
          { label: '48', image: `${path}/pingente-48.png`, enabled: true },
          { label: '49', image: `${path}/pingente-49.png`, enabled: true },
          { label: '50', image: `${path}/pingente-50.png`, enabled: true },
          { label: '51', image: `${path}/pingente-51.png`, enabled: true },
          { label: '52', image: `${path}/pingente-52.png`, enabled: true },
          { label: '53', image: `${path}/pingente-53.png`, enabled: true },
          { label: '54', image: `${path}/pingente-54.png`, enabled: true },
          { label: '55', image: `${path}/pingente-55.png`, enabled: true },
          { label: '56', image: `${path}/pingente-56.png`, enabled: true }
        ]
      },
    ]
  }
]

$(document).ready(function() {
    // Função utilitária para pegar a última classe
    
  if($('.pagina-produto').length > 0){
    $(`.atributos li:first-child a`).click();
    function getLastClass(classString) {
      let classes = classString.trim().split(/\s+/);
      return classes[classes.length - 1];
    }

    // Evento para botão comprar
    $(document).on('click', '.botao-comprar', function(e) {      
      e.preventDefault();
      theme.functions.blockPage(true)
      
      // SKU do produto
      let $acoesProduto = $(this).closest('.acoes-produto');
      let sku = getLastClass($acoesProduto.attr('class'));
      let produtoId = $acoesProduto.data('produto-id');
      // Opções selecionadas
      let customOptions = [];
      console.log($('#customizer .option.selected').length)
      $('#customizer .option.selected').each(function() {
        let label = $(this).find('span').text();
        let customTitle = $(this).closest('.customization').find('.customization-title').text();
        let image = $(this).find('img').attr('src') ? $(this).find('img').attr('src') : '';
        customOptions.push({ customTitle, label, image });
      });
      console.log(customOptions)
      // Salva no sessionStorage
      let newItem = {
        sku: sku,
        produtoId: produtoId,
        customizations: customOptions
      };
      let saved = sessionStorage.getItem('goffer_customizer');
      let arr = [];
      if (saved) {
        try {
          arr = JSON.parse(saved);
          if (!Array.isArray(arr)) arr = [arr];
        } catch (e) {
          arr = [];
          theme.functions.blockPage(false)
        }
      }
      // Verifica se já existe o SKU
      let found = false;
      for (let i = 0; i < arr.length; i++) {
        if (arr[i].sku === sku) {
          arr[i].customizations = customOptions;
          found = true;
          break;
        }
      }
      if (!found) {
        arr.push(newItem);
      }
      
      sessionStorage.setItem('goffer_customizer', JSON.stringify(arr));
      
      window.location = $(this).attr('href');
    });
    let q = customizer.filter(item => item.productId === parseInt(window.PRODUTO_ID));
    if(q.length > 0){
      $('body').on('click','a[data-variacao-id]', function(){
  // Remove aviso anterior
  
        let variacaoId = $(this).data('variacao-id');
        $('#customizer .customization').each(function() {
          const $custom = $(this);
          const hasEnabledClass = $custom.hasClass('enabled-all') || $custom.hasClass(`enabled-${variacaoId}`);
          if (hasEnabledClass) {
            $custom.removeClass('hide');
          } else {
            $custom.addClass('hide');
            $custom.find('.option.selected').removeClass('selected');
          }
        });
        // Consulta sessionStorage para personalização do SKU
        let sku = getLastClass($('.acoes-produto[data-variacao-id="'+variacaoId+'"]').attr('class'));
        let saved = sessionStorage.getItem('goffer_customizer');
        let arr = [];
        if (saved) {
          try {
            arr = JSON.parse(saved);
            if (!Array.isArray(arr)) arr = [arr];
          } catch (e) {
            arr = [];
          }
        }
        let item = arr.find(i => i.sku === sku);
        // Remove aviso anterior
        $('.aviso-personalizado-carrinho').remove();
        // Exibe aviso se já existe personalização para o SKU
        console.log(sku,item);
        if (item && item.customizations && item.customizations.length > 0) {
          $('.atributos').after(`<div class="alert alert-danger aviso-personalizado-carrinho" >${aviso_titulo}<small>${aviso_mensagem}</small></div>`);
          // Adiciona classe disabled ao .acoes-produto correspondente
          $(`.acoes-produto.${sku}`).attr('disabled',true);
        }
        // Limpa seleções atuais
        $('#customizer .option.selected').removeClass('selected');
        if (item && item.customizations) {
          item.customizations.forEach(opt => {
            $('#customizer .customization').each(function() {
              let $custom = $(this);
              let title = $custom.find('.customization-title').text();
              if (title === opt.customTitle) {
                $custom.find('.option').each(function() {
                  if ($(this).data('label') == opt.label) {
                    $(this).addClass('selected');
                  }
                });
              }
            });
          });
        }
        
        // Atualiza a exibição das opções selecionadas
        atualizarSelecionados();
      });
      $('.principal .acoes-produto').first().before('<div id="customizer"><div class="titulo">' + q[0].title + '</div><div class="customizer-content"></div></div>');
      q[0].customizations.forEach(customization => {
            let optionsHtml = customization.options.map(option => {
              let disabledClass = option.enabled === false ? 'disabled' : '';
              if (option.image && option.image.trim() !== '') {
                return `<div class="option ${disabledClass}" data-label="${option.label}" data-image="${option.image}"><img loading=lazy src="${option.image}" alt="${option.label}" class="option-image" /> <span>${option.label}</span></div>`;
              } else {
                return `<div class="option ${disabledClass}" data-label="${option.label}">${option.label}</div>`;
              }
            }).join('');
        let enabledClasses = customization.enableOnVariants.map(v => `enabled-${v}`).join(' ');
        let customizationHtml = `
          <div class="customization ${customization.enableOnVariants.length > 0 ? 'hide' : 'enabled-all'} ${enabledClasses}">
            <div class="customization-title">${customization.title}</div>
            <div class="customization-options">${optionsHtml}</div>
          </div>
        `;
        $('#customizer .customizer-content').append(customizationHtml);
      });
      // Adiciona a div de opções selecionadas (inicialmente oculta)
      $('#customizer').append('<div id="selected-options" style="display: none;"><h3>Opções Selecionadas</h3><div class="selected-list"></div></div>');
      
      // Chamada inicial para configurar o estado correto
      atualizarSelecionados();
      // Evento para selecionar opção
      $('#customizer .option').not('.disabled').on('click', function() {
        let $this = $(this);
        let label = $this.data('label');
        let image = $this.data('image');
        // Remove seleção anterior do mesmo grupo
        $this.closest('.customization-options').find('.option').removeClass('selected');
        $this.addClass('selected');
        atualizarSelecionados();

        // Rolar para a próxima customização visível
        let $currentCustomization = $this.closest('.customization');
        let $nextCustomization = $currentCustomization.nextAll('.customization:visible').first();
        // Verifica se todas as customizações visíveis têm uma opção selecionada
        let todasSelecionadas = true;
        $('.customizer-content .customization:visible').each(function() {
          if ($(this).find('.option.selected').length === 0) {
            todasSelecionadas = false;
          }
        });
        if (todasSelecionadas) {
          // Rola para a seção de opções selecionadas
          let $selectedSection = $('#selected-options');
          if ($selectedSection.length) {
            $('html, body').animate({
              scrollTop: $selectedSection.offset().top - 100
            }, 400);
          }
        } else if ($nextCustomization.length) {
          $('html, body').animate({
            scrollTop: $nextCustomization.offset().top - 100 // ajuste do topo
          }, 400);
        }
      });
      function atualizarSelecionados() {
        let selecionados = [];
        $('#customizer .option.selected').each(function() {
          let label = $(this).data('label');
          let image = $(this).data('image');
          let customTitle = $(this).closest('.customization').find('.customization-title').text();
          selecionados.push({ label, image, customTitle });
        });
        
        // Verifica se há opções selecionadas
        if (selecionados.length > 0) {
          // Se há opções selecionadas, exibe a seção
          $('#selected-options').show();
          
          // Cria o HTML das opções selecionadas
          let html = selecionados.map(opt => {
            if (opt.image) {
              return `<div class="selected-option-case"><strong>${opt.customTitle}:</strong><div class="selected-option"><img src="${opt.image}" alt="${opt.label}" class="option-image" /> <span>${opt.label}</span></div></div>`;
            } else {
              return `<div class="selected-option-case"><strong>${opt.customTitle}:</strong><div class="selected-option"><span>${opt.label}</span></div></div>`;
            }
          }).join('');
          
          // Atualiza o conteúdo da lista
          $('#selected-options .selected-list').html(html);
        } else {
          // Se não há opções selecionadas, oculta a seção
          $('#selected-options').hide();
        }
      }
    }
  }
  if($(`.pagina-pedido-finalizado`).length ){
    sessionStorage.removeItem('goffer_customizer');
  }
  if($(`.pagina-carrinho`).length) {
    // Código específico para a página do carrinho
    $('[data-produto-id]').each(function() {
      const produtoId = $(this).data('produto-id');
      let saved = sessionStorage.getItem('goffer_customizer');
      let arr = [];
      if (saved) {
        try {
          arr = JSON.parse(saved);
          if (!Array.isArray(arr)) arr = [arr];
        } catch (e) {
          arr = [];
        }
      }
      // Obtém o SKU do produto no carrinho (pode ser necessário ajustar o seletor conforme a estrutura do HTML)
      let produtoSku = '';
      try {
        // Tenta obter o SKU do elemento do carrinho
        const classesProduto = $(this).attr('class');
        if (classesProduto) {
          const classes = classesProduto.split(' ');
          // Assume que a última classe é o SKU, como em outras partes do código
          produtoSku = classes[classes.length - 1];
          console.log("SKU do produto no carrinho:", produtoSku);
        }
      } catch(e) {
        console.error("Erro ao obter SKU do produto:", e);
      }
      
      // Busca pelo produtoId e, se disponível, também pelo SKU
      const item = arr.find(i => {
        if (i.produtoId == produtoId) {
          // Se temos o SKU, verificamos se corresponde
          if (produtoSku && i.sku) {
            return i.sku === produtoSku;
          }
          // Se não temos o SKU ou ele não corresponde, apenas consideramos o produtoId
          return true;
        }
        return false;
      });
      
      if (item && item.customizations && item.customizations.length > 0) {
        $(this).find(`.quantidade`).text(`1`);
        
        // Adiciona um identificador específico ao produto personalizado
        $(this).addClass('produto-personalizado');
        
        // Manipulador de clique para o link de exclusão
        $(this).find(`.excluir a`).click(function(e){
          e.preventDefault();
          let href = $(this).attr('href');
          
          // Mostra indicador de carregamento
          theme.functions.blockPage(true);
          
          // Remove o item de personalização do sessionStorage
          console.log("Removendo personalização para produto ID:", produtoId);
          
          // Obtém o SKU do produto a ser removido (se disponível)
          let produtoSku = '';
          try {
            // Tenta obter o SKU do elemento ancestral mais próximo com classe
            const $itemContainer = $(this).closest('[class*="sku-"]');
            if ($itemContainer.length) {
              const classesProduto = $itemContainer.attr('class');
              if (classesProduto) {
                const classes = classesProduto.split(' ');
                // Tenta encontrar uma classe que comece com "sku-"
                for (let i = 0; i < classes.length; i++) {
                  if (classes[i].startsWith('sku-')) {
                    produtoSku = classes[i].replace('sku-', '');
                    break;
                  }
                }
              }
            }
            console.log("SKU do produto a remover:", produtoSku);
          } catch(e) {
            console.error("Erro ao obter SKU do produto para remoção:", e);
          }
          
          let saved = sessionStorage.getItem('goffer_customizer');
          let arr = [];
          
          if (saved) {
            try {
              arr = JSON.parse(saved);
              if (!Array.isArray(arr)) arr = [arr];
              
              // Armazena o tamanho anterior para verificar se algo foi removido
              const tamanhoAnterior = arr.length;
              
              // Filtra o array removendo o item com o produtoId e SKU correspondentes
              arr = arr.filter(i => {
                // Se temos o SKU e ele corresponde ao item atual, removemos
                if (produtoSku && i.sku === produtoSku) {
                  return false;
                }
                // Se não temos o SKU, usamos apenas o produtoId
                return i.produtoId != produtoId;
              });
              
              // Verifica se algo foi removido
              if (arr.length < tamanhoAnterior) {
                console.log("Personalização removida com sucesso");
              } else {
                console.warn("Nenhuma personalização encontrada para remover");
              }
              
              // Salva o array atualizado no sessionStorage
              sessionStorage.setItem('goffer_customizer', JSON.stringify(arr));
            } catch (e) {
              console.error("Erro ao processar sessionStorage:", e);
            }
          }
          
          // Adiciona um pequeno delay para garantir que o sessionStorage seja atualizado
          setTimeout(function() {
            // Redireciona para o link de exclusão original
            window.location = href;
          }, 100);
        });
        
        const $ul = $(this).find('ul');
        item.customizations.forEach(opt => {
          let liContent = `${opt.customTitle}:&nbsp; <strong>${opt.label}</strong>`;
          if (opt.image) {
            liContent += ` <img src="${opt.image}" alt="${opt.label}" style="max-width:32px;max-height:32px;vertical-align:middle;" />`;
          }
          $ul.append(`<li>${liContent}</li>`);
        });
      }
    });


    const $clienteObs = $('[name="cliente_obs"]');
    if ($clienteObs.length) {
      
      const $duplicata = $clienteObs.clone().attr('name', 'cliente_obs_dup').val('');
      $clienteObs.after($duplicata);
      $clienteObs.hide();
      $duplicata.on('input', function() {
        let texto = $(this).val();
        let customizerData = '';
        const saved = sessionStorage.getItem('goffer_customizer');
        let arr = [];
        if (saved) {
          try {
            arr = JSON.parse(saved);
            if (!Array.isArray(arr)) arr = [arr];
          } catch (e) {
            arr = [];
          }
        }
        if (arr.length > 0) {
          customizerData = '\n\n--- Personalizações ---\n';
          arr.forEach(item => {
            customizerData += `SKU: ${item.sku}\n`;
            item.customizations.forEach(opt => {
              customizerData += `- ${opt.customTitle}: ${opt.label}\n`;
            });
          });
          customizerData += '----------------------\n';
        }
        $clienteObs.val(texto + customizerData);
      });
    }

  }
});
